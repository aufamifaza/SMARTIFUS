<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMARTIFUS Monitoring</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
      background: #f4f6f9;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: inline-block;
      min-width: 300px;
    }
    h1 {
      color: #2c3e50;
    }
    .status {
      font-size: 22px;
      margin-top: 10px;
    }
    .normal {
      color: green;
    }
    .warning {
      color: red;
      font-weight: bold;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #3498db;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #2980b9;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>SMARTIFUS</h1>
    <p>Monitoring Berat Infus</p>
    <p>Berat: <span id="berat">-</span></p>
    <p>Status: <span id="status">-</span></p>
    <button id="askPerm">Izinkan Notifikasi</button>
  </div>

  <!-- Firebase SDK (modular v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBDIRSY2vBMdGK10kGVcj5JYkPOGTI6oGc",
      authDomain: "smartifus.firebaseapp.com",
      databaseURL: "https://smartifus-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smartifus",
      storageBucket: "smartifus.appspot.com",
      messagingSenderId: "307663183811",
      appId: "1:307663183811:web:e6d783e210038da31d6776"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Element DOM
    const beratEl = document.getElementById("berat");
    const statusEl = document.getElementById("status");
    const askBtn = document.getElementById("askPerm");
    let alerted = false;

    // Minta izin notifikasi
    askBtn.onclick = () => {
      if ("Notification" in window) {
        Notification.requestPermission().then((perm) => {
          if (perm === "granted") {
            alert("Notifikasi diizinkan ✅");
          } else {
            alert("Notifikasi ditolak ❌");
          }
        });
      } else {
        alert("Browser tidak mendukung Notifications API");
      }
    };

    // Listener berat
    const beratRef = ref(db, "infus/berat");
    onValue(beratRef, (snap) => {
      const val = snap.val();
      if (val === null) return;
      beratEl.innerText = Number(val).toFixed(2) + " g";

      if (val < 100 && !alerted) {
        alerted = true;
        statusEl.className = "status warning";
        if (Notification.permission === "granted") {
          new Notification("⚠ Infus hampir habis", { body: `Berat: ${Number(val).toFixed(2)} g` });
        } else {
          alert("⚠ Infus hampir habis: " + Number(val).toFixed(2) + " g");
        }
      } else if (val >= 100) {
        alerted = false;
        statusEl.className = "status normal";
      }
    });

    // Listener status
    const statusRef = ref(db, "infus/status");
    onValue(statusRef, (snap) => {
      const val = snap.val();
      statusEl.innerText = val || "-";
    });
  </script>
</body>
</html>
